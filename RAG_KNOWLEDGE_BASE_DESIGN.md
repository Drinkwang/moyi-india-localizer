# 本地知识库RAG功能设计方案

## 📋 总体架构

### 设计理念
- **轻量级**：基于文件系统，无需外部数据库
- **离线优先**：所有操作都在本地进行
- **智能检索**：基于关键词匹配和上下文相关性
- **非侵入式**：不增加模型上下文长度，通过动态提示增强

### 文件结构
```
data/
├── knowledge_base/                    # 知识库根目录
│   ├── documents/                     # 原始文档存储
│   │   ├── game_terms/               # 游戏术语
│   │   │   ├── ui_terms.json        # 界面术语
│   │   │   ├── character_names.json  # 角色名称
│   │   │   └── item_names.json       # 物品名称
│   │   ├── technical_docs/           # 技术文档
│   │   │   ├── api_translations.json # API翻译对照
│   │   │   └── code_conventions.json # 代码规范
│   │   └── style_guides/             # 风格指南
│   │       ├── tone_guide.json       # 语调指南
│   │       └── consistency_rules.json # 一致性规则
│   ├── index/                        # 智能索引
│   │   ├── term_mapping.json         # 术语映射索引
│   │   ├── context_rules.json        # 上下文规则
│   │   ├── frequency.json            # 词频统计
│   │   └── similarity_matrix.json    # 相似度矩阵
│   └── cache/                        # 检索缓存
│       ├── recent_queries.json       # 最近查询
│       └── hot_terms.json            # 热门术语
```

## 🔧 核心组件设计

### 1. 知识库管理器 (KnowledgeBaseManager)
```gdscript
# scripts/utils/knowledge_base_manager.gd
class_name KnowledgeBaseManager
extends RefCounted

# 功能：
# - 文档导入与预处理
# - 索引构建与更新
# - 检索接口
# - 缓存管理
```

### 2. 智能检索引擎 (SmartRetriever)
```gdscript
# scripts/utils/smart_retriever.gd
class_name SmartRetriever
extends RefCounted

# 功能：
# - 关键词提取
# - 上下文匹配
# - 相关性评分
# - 结果排序
```

### 3. 提示增强器 (PromptEnhancer)
```gdscript
# scripts/utils/prompt_enhancer.gd
class_name PromptEnhancer
extends RefCounted

# 功能：
# - 动态提示生成
# - 知识注入
# - 模板增强
```

## 📊 数据结构设计

### 术语映射格式
```json
{
  "ui_terms": {
    "metadata": {
      "version": "1.0",
      "last_updated": "2024-01-01T00:00:00Z",
      "category": "界面术语"
    },
    "terms": [
      {
        "source": "Start Game",
        "target": {
          "zh": "开始游戏",
          "ja": "ゲーム開始",
          "ru": "Начать игру"
        },
        "context": ["main_menu", "button"],
        "confidence": 1.0,
        "frequency": 150
      }
    ]
  }
}
```

### 上下文规则格式
```json
{
  "context_rules": [
    {
      "rule_id": "game_ui_consistency",
      "name": "游戏界面一致性",
      "conditions": {
        "keywords": ["button", "menu", "dialog"],
        "text_length": {"min": 1, "max": 20}
      },
      "actions": {
        "enforce_terminology": true,
        "suggest_alternatives": ["按钮", "菜单", "对话框"],
        "style_guide": "简洁明了，符合游戏风格"
      }
    }
  ]
}
```

## 🚀 工作流程

### 文档导入流程
1. **文件解析**：支持CSV、JSON、TXT格式
2. **术语提取**：自动识别翻译对照关系
3. **上下文分析**：分析术语使用场景
4. **索引构建**：建立快速检索索引
5. **质量验证**：检查数据完整性

### 智能检索流程
1. **文本预处理**：分词、关键词提取
2. **多级匹配**：
   - 精确匹配（术语库）
   - 模糊匹配（相似度）
   - 上下文匹配（语义相关）
3. **相关性评分**：综合考虑频率、上下文、历史使用
4. **结果排序**：按相关性和置信度排序
5. **缓存更新**：保存查询结果提高后续性能

### 提示增强流程
1. **检索触发**：检测待翻译文本的关键特征
2. **知识匹配**：查找相关术语和规则
3. **提示构建**：动态生成增强提示
4. **模板注入**：将知识无缝集成到翻译模板中

## 🎯 实现策略

### 第一阶段：基础框架
- [ ] 创建知识库目录结构
- [ ] 实现基础的文件管理功能
- [ ] 开发简单的术语匹配功能
- [ ] 集成到现有翻译流程

### 第二阶段：智能检索
- [ ] 实现关键词提取算法
- [ ] 开发相似度计算功能
- [ ] 建立上下文规则引擎
- [ ] 添加缓存机制

### 第三阶段：高级功能
- [ ] 实现学习功能（基于翻译历史）
- [ ] 开发批量导入工具
- [ ] 添加知识库管理界面
- [ ] 支持多格式文档导入

## 🎮 用户界面设计

### 知识库管理界面
```
┌─ 知识库管理 ─────────────────────────────┐
│ 📁 文档管理                              │
│   ├── 游戏术语/ (156 terms)             │
│   ├── 技术文档/ (89 terms)              │
│   └── 风格指南/ (23 rules)              │
│                                          │
│ 🔍 检索测试                              │
│   输入: [____________] [测试检索]         │
│   结果: 找到 3 个相关术语                │
│                                          │
│ 📊 统计信息                              │
│   总术语数: 268                          │
│   命中率: 89.5%                          │
│   最后更新: 2024-01-01                   │
│                                          │
│ [导入文档] [导出数据] [清理缓存] [关闭]   │
└──────────────────────────────────────────┘
```

### 集成到翻译界面
```
原有模板选择下方添加：
☑️ 启用知识库增强
📋 匹配到 5 个相关术语 [查看详情]
```

## 📈 性能优化

### 缓存策略
- **热点术语缓存**：常用术语保持在内存中
- **查询结果缓存**：相同查询直接返回缓存结果
- **增量更新**：只更新变化的索引部分

### 检索优化
- **分层索引**：按类别和频率建立多级索引
- **异步处理**：非阻塞的后台检索
- **结果限制**：限制返回结果数量避免性能问题

## 🔒 数据安全

### 本地存储
- 所有数据完全本地化
- 无网络传输风险
- 支持数据备份和恢复

### 格式标准化
- 使用JSON格式便于编辑和版本控制
- 支持Git等版本控制系统
- 便于团队协作和分享

## 🧪 测试方案

### 功能测试
- 术语匹配准确性测试
- 大量数据导入性能测试
- 并发访问稳定性测试

### 用户体验测试
- 检索响应时间测试
- 界面易用性测试
- 翻译质量提升验证

## 📝 使用示例

### 术语匹配示例
```
原文: "Start Game"
检索结果:
1. 精确匹配: "Start Game" → "开始游戏" (confidence: 1.0)
2. 上下文: 主菜单按钮，建议使用简洁风格
3. 历史: 在类似游戏中使用频率 95%

增强后的提示:
请将以下英文游戏界面文本翻译成中文：

参考术语库：
- "Start Game" 通常翻译为 "开始游戏"
- 这是主菜单按钮文本，应简洁明了
- 建议保持与其他菜单项的风格一致

原文: Start Game
```

### 上下文规则示例
```
检测到: 短文本 + 界面类别
应用规则: game_ui_consistency
建议: 使用简洁风格，避免过长翻译
示例: "Settings" → "设置" (而非 "设置选项")
```

## 🎉 预期效果

### 翻译质量提升
- **术语一致性**: 90%+ 一致性提升
- **上下文准确性**: 减少80%的语境错误
- **风格统一性**: 保持品牌和游戏风格

### 工作效率提升
- **自动化程度**: 减少60%的手动查询时间
- **批量处理**: 支持大规模文档翻译
- **学习能力**: 系统自动学习和改进

### 用户体验
- **界面友好**: 直观的管理界面
- **性能优秀**: 毫秒级检索响应
- **扩展性强**: 支持自定义规则和术语库 